<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>上映館リスト（CSV自動反映・タブ式）</title>
<style>
  :root { --bg:#0c0f14; --card:#12161d; --text:#e7ebf3; --muted:#8a93a6; --accent:#4f8cff; --border:#222838; --chip:#1a1f2b; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif}
  header{position:sticky;top:0;z-index:10;background:rgba(12,15,20,.96);backdrop-filter:blur(6px);padding:12px 14px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:18px}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--text);cursor:pointer;font-size:14px}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .filters{display:grid;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border)}
  .filter-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  select,input[type="search"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0f141d;color:var(--text)}
  main{padding:12px 14px}
  .group{margin-top:16px}
  .group h2{font-size:15px;color:var(--muted);margin:0 0 8px}
  .grid{display:grid;gap:10px;grid-template-columns:1fr}
  @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  @media (min-width:1024px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;gap:6px}
  .title{font-weight:600;word-break:break-word}
  .meta{color:var(--muted);font-size:13px;word-break:break-word}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:12px;padding:2px 8px;background:#1a2233;border:1px solid #22304b;border-radius:999px;white-space:nowrap}
  a.btn{display:inline-block;text-decoration:none;color:#fff;background:var(--accent);padding:7px 10px;border-radius:10px;font-size:13px}
  footer{padding:14px;color:var(--muted);font-size:12px;border-top:1px solid var(--border)}
  #csv-debug{position:fixed;left:8px;bottom:8px;max-width:92vw;background:#1f2937;color:#fff;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui,-apple-system;z-index:9999;opacity:.95;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <h1>上映館リスト（CSV自動反映）</h1>
  <div class="tabs" id="tabs">
    <button type="button" class="tab active" data-tab="all">ALL</button>
    <button type="button" class="tab" data-tab="cinema">Dolby Cinema</button>
    <button type="button" class="tab" data-tab="atmos">Dolby Atmos</button>
    <button type="button" class="tab" data-tab="axk">Dolby Atmos×4K</button>
    <button type="button" class="tab" data-tab="ch71">7.1ch</button>
    <button type="button" class="tab" data-tab="k4">4K</button>
  </div>
</header>

<div class="filters">
  <div class="filter-row">
    <select id="prefSelect"><option value="">エリア（すべて）</option></select>
    <input id="q" type="search" placeholder="劇場名・住所で検索…">
  </div>
</div>

<main id="content">
  <div class="group"><h2>読み込み中…</h2></div>
</main>

<footer>
  ※ タブ（ALL / Dolby Cinema / Dolby Atmos / Dolby Atmos×4K / 7.1ch / 4K）と、エリア・検索で絞り込みできます。
</footer>

<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

<script>
/* ====== CSV 公開 URL（そのままでOK） ====== */
var SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShtDnZUCsyJKxq1mUB8Hgid98ngAWYAcgEwhCg2MaV3cqbmyRsEsbr2eyZ8XFdyW00ZdsB2BkJhVuC/pub?gid=1453087675&single=true&output=csv";

/* 見出しの強制指定：エリア & Dolby Cinema（E 列の見出し） */
var OVERRIDE_HEADER = { pref:"エリア", cinema:"Dolby Cinema" };

/* デバッグ表示 */
function dbg(msg){
  var el=document.getElementById('csv-debug');
  if(!el){ el=document.createElement('div'); el.id='csv-debug'; document.body.appendChild(el); }
  el.textContent = (typeof msg==='string')? msg : JSON.stringify(msg,null,2);
}

/* 変な混入文字のクリーニング（contentReference[...] 等） */
function clean(v){
  return String(v||"")
    .replace(/contentReference\[oaicite:\d+\]\{index=\d+\}/gi, '')
    .replace(/[\u200B-\u200D\uFEFF]/g, '')
    .trim();
}

/* 都道府県処理 */
var PREFS = ["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","山梨県","長野県","富山県","石川県","福井県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
var REGIONS = ["北海道","東北","関東","北陸","甲信越","東海","中部","近畿","関西","中国","四国","九州","沖縄"];

function prefectureFromAddress(addr){
  var s=clean(addr).replace(/\s|\u3000/g,"");
  if(!s) return "";
  for(var i=0;i<PREFS.length;i++) if(s.indexOf(PREFS[i])===0) return PREFS[i];
  var short={"東京":"東京都","大阪":"大阪府","京都":"京都府","沖縄":"沖縄県"};
  for(var k in short){ if(s.indexOf(k)===0) return short[k]; }
  return "";
}
function normalizePref(p){
  p=clean(p).replace(/\s|\u3000/g,"");
  if(!p) return '';
  var short={"東京":"東京都","大阪":"大阪府","京都":"京都府","沖縄":"沖縄県","北海道":"北海道"};
  if(short[p]) return short[p];
  var last=p.charAt(p.length-1);
  if(["都","道","府","県"].indexOf(last)===-1 && p!=="北海道") p=p+"県";
  return p;
}
function displayPref(pref){
  if(!pref) return "（エリア不明）";
  if(pref==="北海道") return "北海道";
  if(pref==="東京都") return "東京";
  if(pref==="大阪府") return "大阪";
  if(pref==="京都府") return "京都";
  var last=pref.charAt(pref.length-1);
  if(["都","道","府","県"].indexOf(last)!==-1) return pref.slice(0,-1);
  return pref;
}

/* 列名 → インデックス */
function nHead(s){return clean(s).replace(/\u3000/g,' ').toLowerCase();}
function findIdx(header, aliases){
  var H=header.map(nHead);
  for(var j=0;j<aliases.length;j++){ var key=nHead(aliases[j]); var idx=H.indexOf(key); if(idx!==-1) return idx; }
  return -1;
}
var ALIAS={
  pref:["エリア","都道府県","都道府県名","県名","道府県","地域"],
  name:["劇場名","映画館","映画館名","シアター","館名","名称","劇場"],
  addr:["住所","所在地","住所1","住所_全文","address","所在地住所"],
  url:["URL","url","リンク","公式","公式サイト","サイトURL","公式サイトURL"],
  atmos:["Dolby Atmos","Atmos","ドルビーアトモス","アトモス"],
  ch71:["7.1ch","7.1 ch","7.1CH","7_1ch","7-1ch"],
  k4:["4K","4ｋ","４Ｋ","4k","4K対応"],
  other:["other","備考","メモ","注記","形式"],
  cinema:["Dolby Cinema","DolbyCinema","ドルビーシネマ","DC","ＤＣ"],
  seats:["座席数","席数","シート数","キャパ","収容人数","定員"]
};
function idxByName(header,name){ var H=header.map(nHead); var i=H.indexOf(nHead(name)); return i>=0? i : -1; }
function idxSmart(header,key){
  if (OVERRIDE_HEADER && OVERRIDE_HEADER[key]) {
    var i=idxByName(header, OVERRIDE_HEADER[key]);  // 正規化比較
    if (i!==-1) return i;
  }
  return findIdx(header, ALIAS[key]);
}

/* 値の判定（◯/1/TRUE/文字含む など） */
function isTruthy(v){
  var s = nHead(v);
  if (!s) return false;
  if (["1","true","yes","y","on","◯","○","✔","✓","有","あり","ok"].indexOf(s)!==-1) return true;
  if (/dolby\s*cinema/.test(s) || /ドルビーシネマ/.test(s)) return true;
  return false;
}

/* CSV → データ構築 */
function buildDataFromRows(header, rows){
  var iPref  = idxSmart(header,"pref");
  var iName  = idxSmart(header,"name");
  var iAddr  = idxSmart(header,"addr");
  var iURL   = idxSmart(header,"url");
  var iAt    = idxSmart(header,"atmos");
  var i71    = idxSmart(header,"ch71");
  var i4K    = idxSmart(header,"k4");
  var iOther = idxSmart(header,"other");
  var iSeats = idxSmart(header,"seats");
  var iCinema= idxSmart(header,"cinema");   // ← Dolby Cinema 列

  var data=[], present={};

  for(var r=0;r<rows.length;r++){
    var row=rows[r]||[];

    var raw = (iPref>-1? row[iPref] : "");
    var rawTrim = clean(raw).replace(/\s|\u3000/g,"");
    var isRegion = REGIONS.indexOf(rawTrim)!==-1;
    var prefNorm = normalizePref(isRegion? "" : rawTrim);
    if(!prefNorm){
      var guess = prefectureFromAddress(iAddr>-1? row[iAddr] : "");
      prefNorm = normalizePref(guess);
    }

    var cinemaFlag = false;
    if (iCinema>-1) cinemaFlag = isTruthy(row[iCinema]);
    else if (iOther>-1) cinemaFlag = isTruthy(row[iOther]); // otherに文字で入ってる保険

    var rec = {
      prefNorm: prefNorm,
      prefDisp: displayPref(prefNorm),
      theater : iName>-1?  clean(row[iName])  : "",
      address : iAddr>-1?  clean(row[iAddr])  : "",
      url     : iURL>-1?   clean(row[iURL])   : "",
      atmos   : iAt>-1?    clean(row[iAt])    : "",
      ch71    : i71>-1?    clean(row[i71])    : "",
      k4      : i4K>-1?    clean(row[i4K])    : "",
      other   : iOther>-1? clean(row[iOther]) : "",
      seats   : iSeats>-1? clean(row[iSeats]) : "",
      cinema  : cinemaFlag
    };
    data.push(rec);
    if(rec.prefNorm) present[rec.prefNorm]=true;
  }

  var prefects=[];
  for(var i=0;i<PREFS.length;i++){ if(present[PREFS[i]]) prefects.push({norm:PREFS[i], disp:displayPref(PREFS[i])}); }
  if(data.some(function(d){return !d.prefNorm;})) prefects.push({norm:"", disp:"（エリア不明）"});

  dbg("ヘッダー検出:\n  エリア: "+(iPref>-1? header[iPref]:"(未検出)")+"\n  Dolby Cinema: "+(iCinema>-1? header[iCinema]:"(未検出)")+"\n  住所: "+(iAddr>-1? header[iAddr]:"(未検出)")+"\n  劇場名: "+(iName>-1? header[iName]:"(未検出)"));
  return {data:data, prefects:prefects};
}

/* CSV 読み込み（キャッシュ回避） */
function csvUrlNoCache(){ return SHEET_CSV_URL + '&_t=' + Date.now(); }
(function(){
  Papa.parse(csvUrlNoCache(),{
    download:true, header:false, skipEmptyLines:true,
    complete:function(res){
      var rows=res.data||[]; if(!rows.length){ dbg("CSVが空です"); return; }
      var header=rows[0], body=rows.slice(1);
      var built=buildDataFromRows(header, body);
      window.data=built.data; window.prefects=built.prefects;
      if(typeof initUI==="function"){ initUI(); render(); }
    },
    error:function(err){ console.error(err); dbg("CSV読込エラー。URL/公開設定をご確認ください。"); }
  });
})();

/* ===== UI ===== */
var STATE = { tab:"all", pref:"", q:"" };

function initUI(){
  var tabs=document.getElementById("tabs");
  tabs.onclick=function(e){
    var t=e.target; if(!t || t.className.indexOf("tab")===-1) return;
    var all=tabs.getElementsByClassName("tab");
    for(var i=0;i<all.length;i++){ all[i].classList.remove("active"); }
    t.classList.add("active");
    STATE.tab=t.getAttribute("data-tab");
    render();
  };

  var sel=document.getElementById("prefSelect");
  for(var i=0;i<window.prefects.length;i++){
    var o=document.createElement("option");
    o.value=window.prefects[i].norm; o.textContent=window.prefects[i].disp; sel.appendChild(o);
  }
  sel.onchange=function(){ STATE.pref=this.value; render(); };

  var q=document.getElementById("q");
  q.oninput=function(){ STATE.q=this.value.replace(/^\s+|\s+$/g,""); render(); };
}

function nz(v){ return v && String(v).replace(/\s+/g,"")!==""; }
function matchTab(rec){
  if(STATE.tab==="all")   return true;
  if(STATE.tab==="cinema")return !!rec.cinema;             /* ← Dolby Cinema は列で判定 */
  if(STATE.tab==="atmos") return nz(rec.atmos);
  if(STATE.tab==="axk")   return nz(rec.atmos) && nz(rec.k4);
  if(STATE.tab==="ch71")  return nz(rec.ch71);
  if(STATE.tab==="k4")    return nz(rec.k4);
  return true;
}
function matchFilters(rec){
  if(STATE.pref!=="" && rec.prefNorm!==STATE.pref) return false;
  if(STATE.q){
    var hay=(rec.theater+" "+rec.address+" "+(rec.prefDisp||"")).toLowerCase();
    if(hay.indexOf(STATE.q.toLowerCase())===-1) return false;
  }
  return true;
}
function badgeRow(rec){
  var b=[];
  if(rec.cinema) b.push("🎥 Dolby Cinema");
  if(nz(rec.atmos)) b.push("🎬 Dolby Atmos："+rec.atmos);
  if(nz(rec.k4))    b.push("✨ 4K");
  if(nz(rec.ch71))  b.push("🔊 7.1ch");
  if(!b.length) return "";
  var h='<div class="badges">'; for(var i=0;i<b.length;i++){ h+='<span class="badge">'+b[i]+'</span>'; } h+='</div>'; return h;
}
function seatsLine(rec){
  var s=(rec.seats && String(rec.seats).trim()!=="")? rec.seats : "—";
  if(rec.atmos && String(rec.atmos).trim()!==""){ return '🎬 Dolby Atmos：'+rec.atmos+'（💺 座席数：'+s+'）'; }
  return '💺 座席数：'+s;
}
function card(rec){
  var link=rec.url? '<a class="btn" href="'+rec.url+'" target="_blank" rel="noopener">公式サイト</a>' : '';
  return '<div class="card">'
       +   '<div class="title">'+(rec.theater||"(劇場名不明)")+'</div>'
       +   '<div class="meta">📍 '+(rec.address||"")+'</div>'
       +   '<div class="meta">'+seatsLine(rec)+'</div>'
       +   badgeRow(rec)
       +   link
       + '</div>';
}
function render(){
  if(!window.data){ return; }
  var recs=[]; for(var i=0;i<window.data.length;i++){ var r=window.data[i]; if(matchTab(r)&&matchFilters(r)) recs.push(r); }
  var groups={}; for(var j=0;j<recs.length;j++){ var k=recs[j].prefNorm||""; if(!groups[k]) groups[k]=[]; groups[k].push(recs[j]); }

  var content=document.getElementById("content"), html="";
  for(var p=0;p<window.prefects.length;p++){
    var key=window.prefects[p].norm, arr=groups[key];
    if(!arr||!arr.length) continue;
    html+='<section class="group"><h2>'+window.prefects[p].disp+'</h2><div class="grid">';
    for(var m=0;m<arr.length;m++){ html+=card(arr[m]); }
    html+='</div></section>';
  }
  if(groups[""] && groups[""].length){
    html+='<section class="group"><h2>（エリア不明）</h2><div class="grid">';
    var arrU=groups[""]; for(var u=0;u<arrU.length;u++){ html+=card(arrU[u]); }
    html+='</div></section>';
  }
  if(!html){ html='<div class="group"><h2>該当なし</h2><div class="meta">タブ・エリア・検索を調整してください。</div></div>'; }
  content.innerHTML=html;
}
</script>

</body>
</html>
