<!-- CSVローダー：最後に置く（renderなど既存JSの後） -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
        integrity="sha384-qk7n9x2x8qN0Tq6D7y7ZpC8xH0Qq5mJx0kqQZ7ZqK7v6sM1b8X8T3l8Y8qZq0p7L"
        crossorigin="anonymous"></script>
<script>
  // ★そのままでOK：あなたのCSV公開URL
  var SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShtDnZUCsyJKxq1mUB8Hgid98ngAWYAcgEwhCg2MaV3cqbmyRsEsbr2eyZ8XFdyW00ZdsB2BkJhVuC/pub?gid=1453087675&single=true&output=csv";

  // ミニデバッグ（左下に状況表示）
  function dbg(msg){
    var el=document.getElementById('csv-debug');
    if(!el){ el=document.createElement('div'); el.id='csv-debug';
      el.style.cssText='position:fixed;left:8px;bottom:8px;max-width:92vw;background:#1f2937;color:#fff;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui,-apple-system;z-index:9999;opacity:.95';
      document.body.appendChild(el);
    }
    el.textContent='[CSV] '+msg;
  }

  // 列名ゆらぎ対応
  function nHead(s){return String(s||'').replace(/\u3000/g,' ').trim().toLowerCase();}
  function findIdx(h, aliases){var H=h.map(nHead);for(var i=0;i<aliases.length;i++){var k=nHead(aliases[i]);var j=H.indexOf(k);if(j!==-1)return j;}return-1;}
  var ALIAS={
    pref:["都道府県","都道府県名","県名","道府県","都道府県 "],
    name:["劇場名","映画館","映画館名","シアター","館名"],
    addr:["住所","所在地","住所1","住所_全文","address"],
    url:["URL","url","リンク","公式","公式サイト","サイトURL"],
    atmos:["Dolby Atmos","Atmos","ドルビーアトモス","アトモス"],
    ch71:["7.1ch","7.1 ch","7.1CH","7_1ch","7-1ch"],
    k4:["4K","4Ｋ","４Ｋ","4k"],
    other:["other","備考","メモ","注記"],
    seats:["座席数","席数","シート数","キャパ","収容人数"]
  };

  function normalizePref(p){
    p=String(p||'').trim(); if(!p) return '';
    var short={"東京":"東京都","大阪":"大阪府","京都":"京都府","沖縄":"沖縄県","北海道":"北海道"};
    if(short[p]) return short[p];
    var last=p[p.length-1]; if(["都","道","府","県"].indexOf(last)===-1 && p!=="北海道") return p+"県";
    return p;
  }
  function displayPref(pref){
    if(!pref) return ""; if(pref==="北海道") return "北海道";
    if(pref==="東京都") return "東京"; if(pref==="大阪府") return "大阪"; if(pref==="京都府") return "京都";
    var last=pref[pref.length-1]; if(["都","道","府","県"].indexOf(last)!==-1) return pref.slice(0,-1);
    return pref;
  }

  function buildData(header, rows){
    var ip=findIdx(header,ALIAS.pref), iname=findIdx(header,ALIAS.name), iaddr=findIdx(header,ALIAS.addr),
        iurl=findIdx(header,ALIAS.url), iat=findIdx(header,ALIAS.atmos), i71=findIdx(header,ALIAS.ch71),
        i4k=findIdx(header,ALIAS.k4), ioth=findIdx(header,ALIAS.other), iseat=findIdx(header,ALIAS.seats);

    if(ip===-1||iname===-1){ dbg("必須列（都道府県/劇場名）が見つかりません"); }

    var data=[];
    for(var r=0;r<rows.length;r++){
      var row=rows[r], prefN=normalizePref(ip>-1?row[ip]:"");
      data.push({
        prefNorm: prefN, prefDisp: displayPref(prefN),
        theater:  iname>-1? String(row[iname]||"").trim():"",
        address:  iaddr>-1? String(row[iaddr]||"").trim():"",
        url:      iurl>-1?  String(row[iurl]||"").trim():"",
        atmos:    iat>-1?   String(row[iat]||"").trim():"",
        ch71:     i71>-1?   String(row[i71]||"").trim():"",
        k4:       i4k>-1?   String(row[i4k]||"").trim():"",
        other:    ioth>-1?  String(row[ioth]||"").trim():"",
        seats:    iseat>-1? String(row[iseat]||"").trim():""
      });
    }

    var order=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","山梨県","長野県","富山県","石川県","福井県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
    var present={}; for(var i=0;i<data.length;i++){ if(data[i].prefNorm) present[data[i].prefNorm]=true; }
    var prefs=[]; for(var j=0;j<order.length;j++){ var p=order[j]; if(present[p]) prefs.push({norm:p,disp:displayPref(p)}); }
    var extra={}; for(var k=0;k<data.length;k++){ var pn=data[k].prefNorm; if(pn && !present["#"+pn] && order.indexOf(pn)===-1){ prefs.push({norm:pn,disp:displayPref(pn)}); present["#"+pn]=true; } }
    return {data:data, prefects:prefs};
  }

  (function run(){
    Papa.parse(SHEET_CSV_URL, {
      download:true, header:false, skipEmptyLines:true,
      complete:function(res){
        var rows=res.data||[]; if(!rows.length){ dbg("CSVが空です"); return; }
        var header=rows[0], body=rows.slice(1);
        var built=buildData(header, body);
        window.data=built.data; window.prefects=built.prefects;
        dbg("読み込み成功: "+built.data.length+"件 / 都道府県 "+built.prefects.length);
        // 既存の render() を呼ぶ（描画ロジックを残していれば存在します）
        if (typeof window.render==="function") window.render();
      },
      error:function(err){ console.error(err); dbg("CSV読込エラー。URLと公開設定を確認"); }
    });
  })();
</script>
